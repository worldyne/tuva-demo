version: 2

models:
  # Staging Models
  - name: stg_oncology_conditions
    description: >
      Staging model that filters core__condition to ICD-10 neoplasm codes (C00-D49).
      Classifies each condition into a cancer_type based on ICD-10 code ranges.
    columns:
      - name: condition_id
        description: Unique identifier for the condition
      - name: person_id
        description: Patient identifier
      - name: normalized_code
        description: Normalized ICD-10 diagnosis code
      - name: cancer_type
        description: >
          Cancer type classification (e.g., Breast, Hematologic, Digestive Organs)
          derived from ICD-10 code ranges

  - name: stg_oncology_claims
    description: >
      Staging model that filters core__medical_claim to only claims 
      for patients in the oncology cohort.
    columns:
      - name: medical_claim_id
        description: Unique identifier for the claim line
      - name: person_id
        description: Patient identifier
      - name: paid_amount
        description: Amount paid by payer

  # Intermediate Models
  - name: int_oncology_cohort
    description: >
      Identifies patients with active cancer using the 2+ claims rule.
      Assigns primary cancer type based on most frequent diagnosis.
    columns:
      - name: person_id
        description: Patient identifier
        tests:
          - unique
      - name: primary_cancer_type
        description: Most common cancer type for this patient
      - name: cancer_claim_count
        description: Number of distinct claims with cancer diagnoses
      - name: cohort_name
        description: Cohort identifier (Active Oncology)

  - name: int_oncology_financials
    description: >
      Cost breakdown by care setting and cancer type for oncology patients.
      Includes spend bucket segmentation.
    columns:
      - name: person_id
        description: Patient identifier
      - name: primary_cancer_type
        description: Patient's primary cancer type
      - name: care_setting
        description: Care setting from service_category_1 (Inpatient, Outpatient, etc.)
      - name: total_paid
        description: Total paid amount for this patient/care setting combination
      - name: spend_bucket
        description: Cost segmentation (High Cost, Medium Cost, Low Cost, Minimal Cost)
      - name: spend_quartile
        description: Spend quartile (1-4) based on patient total spend

  # Mart Models
  - name: fact_oncology_patient_detail
    description: >
      Patient-level detail mart with full ICD-10 code traceability.
      Includes all cancer codes, spend by care setting, and cost metrics per patient.
    columns:
      - name: person_id
        description: Patient identifier
        tests:
          - unique
      - name: all_cancer_codes
        description: Array of all distinct ICD-10 cancer codes for this patient
      - name: all_cancer_descriptions
        description: Array of all distinct cancer code descriptions
      - name: primary_cancer_type
        description: Most common cancer type for this patient
      - name: total_paid
        description: Total paid amount across all claims
      - name: spend_bucket
        description: Cost tier segmentation

  - name: fact_oncology_cost_analytics
    description: >
      Final analytics mart aggregating oncology costs by care setting, 
      cancer type, and spend bucket. Ready for BI consumption.
    columns:
      - name: care_setting
        description: Care setting (Inpatient, Outpatient, Emergency, etc.)
      - name: primary_cancer_type
        description: Cancer type category
      - name: spend_bucket
        description: Cost tier segmentation
      - name: patient_count
        description: Number of unique patients
      - name: total_paid_amount
        description: Sum of paid amounts
      - name: pct_of_total_paid
        description: Percentage of total oncology spend
      - name: paid_per_patient
        description: Average paid amount per patient
      - name: claims_per_patient
        description: Average number of claims per patient

  # Star Schema Dimensions
  - name: dim_cancer_type
    description: >
      Reference dimension for cancer type classification based on ICD-10 ranges.
      Includes 21 categories covering malignant, benign, in situ, and uncertain behavior neoplasms.
    columns:
      - name: cancer_type_key
        description: Surrogate key for cancer type
        tests:
          - unique
          - not_null
      - name: cancer_type_name
        description: Display name for the cancer type category
      - name: icd10_range_start
        description: Start of ICD-10 code range (inclusive)
      - name: icd10_range_end
        description: End of ICD-10 code range (exclusive)
      - name: category
        description: Behavior category (Malignant, Benign, In Situ, Uncertain, Unspecified)
      - name: sort_order
        description: Display order for reporting

  - name: dim_care_setting
    description: >
      Reference dimension for care settings derived from Tuva's service_category_1.
    columns:
      - name: care_setting_key
        description: Surrogate key for care setting
        tests:
          - unique
          - not_null
      - name: care_setting_code
        description: Original code from service_category_1
      - name: care_setting_name
        description: Display name for the care setting
      - name: sort_order
        description: Display order for reporting

  - name: dim_spend_bucket
    description: >
      Reference dimension for patient spend tier segmentation.
      Thresholds: High >$100k, Medium $25k-$100k, Low $5k-$25k, Minimal <$5k.
    columns:
      - name: spend_bucket_key
        description: Surrogate key for spend bucket
        tests:
          - unique
          - not_null
      - name: spend_bucket_name
        description: Display name for the spend tier
      - name: min_threshold
        description: Minimum spend amount for this bucket (inclusive)
      - name: max_threshold
        description: Maximum spend amount for this bucket (inclusive, null for highest tier)
      - name: sort_order
        description: Display order for reporting (1=highest spend)

  - name: dim_patient
    description: >
      Patient dimension for oncology cohort. Contains patient-level attributes
      including all cancer codes for ICD-10 traceability.
    columns:
      - name: person_id
        description: Patient identifier (natural key)
        tests:
          - unique
          - not_null
      - name: cohort_name
        description: Cohort identifier (Active Oncology)
      - name: primary_cancer_type
        description: Most common cancer type for this patient
      - name: cancer_claim_count
        description: Number of distinct claims with cancer diagnoses
      - name: most_recent_diagnosis_date
        description: Date of most recent cancer diagnosis
      - name: all_cancer_codes
        description: Array of all distinct ICD-10 cancer codes for this patient
      - name: all_cancer_descriptions
        description: Array of all distinct cancer code descriptions

  # Star Schema Fact
  - name: fact_oncology_cost
    description: >
      Fact table for oncology cost analysis. Grain is patient + cancer_type + care_setting.
      Joins to dim_patient, dim_cancer_type, dim_care_setting, and dim_spend_bucket.
    columns:
      - name: person_id
        description: Patient identifier (FK to dim_patient)
        tests:
          - not_null
      - name: cancer_type_key
        description: FK to dim_cancer_type
        tests:
          - not_null
      - name: care_setting_key
        description: FK to dim_care_setting
        tests:
          - not_null
      - name: spend_bucket_key
        description: FK to dim_spend_bucket
      - name: paid_amount
        description: Total paid amount for this combination
      - name: allowed_amount
        description: Total allowed amount
      - name: total_cost_amount
        description: Total cost amount
      - name: claim_count
        description: Number of claims
